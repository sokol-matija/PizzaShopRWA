name: ðŸ§ª Run Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ðŸ”¬ Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        dotnet-version: [ '8.0.x' ]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore TravelOrganizationSystem/
      
    - name: ðŸ—ï¸ Build projects
      run: dotnet build TravelOrganizationSystem/ --no-restore --configuration Release
      
    - name: ðŸ§ª Run Unit Tests - WebAPI
      run: |
        echo "ðŸš€ Running WebAPI Tests..."
        dotnet test TravelOrganizationSystem/WebAPI.Tests/ \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --logger "trx;LogFileName=webapi-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
          
    - name: ðŸ§ª Run Unit Tests - WebApp
      run: |
        echo "ðŸš€ Running WebApp Tests..."
        dotnet test TravelOrganizationSystem/WebApp.Tests/ \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --logger "trx;LogFileName=webapp-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
          
    - name: ðŸ§ª Run Integration Tests
      run: |
        echo "ðŸš€ Running Integration Tests..."
        dotnet test TravelOrganizationSystem/Integration.Tests/ \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --logger "trx;LogFileName=integration-results.trx" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
          
    - name: ðŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.dotnet-version }}
        path: |
          TravelOrganizationSystem/**/TestResults/**/*.trx
          TravelOrganizationSystem/**/TestResults/**/*.xml
          
    - name: ðŸ“ˆ Upload Coverage Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports-${{ matrix.dotnet-version }}
        path: |
          TravelOrganizationSystem/**/TestResults/**/*.cobertura.xml
          
    - name: ðŸ“ Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **WebAPI Tests**: Check detailed logs above" >> $GITHUB_STEP_SUMMARY
        echo "- **WebApp Tests**: Check detailed logs above" >> $GITHUB_STEP_SUMMARY
        echo "- **Integration Tests**: Check detailed logs above" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Coverage Reports" >> $GITHUB_STEP_SUMMARY
        echo "Coverage reports have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ—ï¸ Build Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **.NET Version**: ${{ matrix.dotnet-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **OS**: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration**: Release" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ðŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: ðŸ“Š Job Status Check
      run: |
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… All tests passed successfully!"
          echo "TESTS_STATUS=âœ… PASSED" >> $GITHUB_ENV
        else
          echo "âŒ Some tests failed!"
          echo "TESTS_STATUS=âŒ FAILED" >> $GITHUB_ENV
        fi
        
    - name: ðŸ“ Final Summary
      run: |
        echo "## ðŸŽ¯ Final Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: ${{ env.TESTS_STATUS }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "- âœ… All tests are passing" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Ready for deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Fix failing tests" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Check detailed logs above" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ Review test artifacts" >> $GITHUB_STEP_SUMMARY
        fi